# CLAUDE.md - 南网施工方案智能辅助系统

> [!URGENT]
> **研究性项目 (Research Project)**
> 1. 本项目为 MVP（最小可行性产品），严禁过度工程化
> 2. 你的所有思考过程和回复必须使用 **简体中文**

---

## 1. 项目元数据 (Metadata)

- **核心目标**: 为南方电网构建施工方案智能辅助系统，实现检测（审核）和生成两大功能
- **项目类型**: MVP / 研究性项目
- **技术栈**: Python + LangChain + LangGraph（多智能体系统）
- **向量数据库**: ChromaDB
- **语义检索**: LightRAG
- **Conda 环境**: `sca` (Python 3.10)
- **项目周期**: 2026-01 至 2026-12（中期检查 2026-06-30）

---

## 2. 常用命令 (Commands)

### Conda 环境管理
```bash
# 激活环境
conda activate sca

# 使用 conda run 执行命令
conda run -n sca python main.py --input data --output output
```

> [!CRITICAL] 所有 Python 命令必须在 `sca` conda 环境中执行

### 代码质量检查
```bash
# 格式化
conda run -n sca ruff format .

# 检查
conda run -n sca ruff check .
```

### 测试命令
```bash
# 运行测试
conda run -n sca pytest tests/ -v

# 带覆盖率
conda run -n sca pytest tests/ --cov=. --cov-report=term-missing
```

### 主程序入口
```bash
# 处理 PDF（OCR + 清洗）
conda run -n sca python main.py --input data/1.pdf --output output

# 批量处理
conda run -n sca python main.py --input data --output output
```

### Docker（OCR 服务）
```bash
# 启动 MonkeyOCR 服务
docker start monkeyocr-api

# 检查状态
docker ps | grep monkeyocr
```

---

## 3. 标准作业程序 (Standard Operating Procedure)

> **Coding Agent 必须严格遵守以下生命周期执行任务：**

### Phase 1: 规划与设计 (Planning)

1. **查阅规格 (Read Specs)**
   - 阅读 `CLAUDE.md` 了解项目上下文
   - 阅读 `templates/standard_50502.md` 了解施工方案 7 大章节标准
   - 阅读 `output/1/final.md` 了解清洗后的数据格式

2. **草稿 (Drafting)**
   - 复杂逻辑先在 `draft.md` 中理清思路
   - 列出关键函数签名和数据流

3. **计划 (Plan)**
   - 输出 `implementation_plan.md`，必须包含：
     - **摘要**: 1-2 句话总结
     - **审查点**: 不清楚、需要确认的部分
     - **拟议变更**: 文件名 + 函数级修改，标注 `[NEW]`/`[MODIFY]`/`[DELETE]`
     - **验证计划**: 具体测试命令和预期输出

4. **等待 (Wait)**
   - 暂停并等待用户审核开发计划

### Phase 2: 执行与验证 (Execution & Verification)

1. **编码 (Coding)**
   - 在 `sca` conda 环境中编码
   - 遵守核心规则（见下文）

2. **验证 (Verify)**
   - 运行测试：`pytest tests/ -v`
   - 失败则修复，循环直到通过

### Phase 3: 收尾与交付 (Finalization)

1. **文档同步 (Docs Sync)**
   - 检查代码修改是否导致文档过时
   - 更新 README.md、架构图、使用指南

2. **提交 (Commit)**
   - 格式: Conventional Commits (`feat:`, `fix:`, `docs:`, `refactor:`)
   - 信息: 清晰、简洁
   - **严禁** commit message 中添加 AI 标识

---

## 4. 核心规则 (Rules)

### 4.1 代码开发规范 (Code Style)

- **类型系统**: 强制所有函数签名包含完整类型注解 (`Union`, `Dict`, `Optional` 等)
- **文档**: 所有模块、类、方法必须包含 **中文 Docstring** (功能、参数、返回值、关键实现细节)
- **MVP原则**:
  - **严禁** 随意添加测试代码
  - **严禁** 使用默认参数掩盖仅需逻辑（必须显式传递关键参数）
  - **必需** 运行时检查：关键维度、设备一致性必须通过 assertion 或 if 验证
- **命名**:
  - 类名 `PascalCase`
  - 变量描述性命名
  - 私有变量前缀 `_`
  - 导入顺序：标准库 → 第三方库 → 项目内部
- **日志与错误处理**:
  - **必须**使用 `utils/logger_system.py` 提供的 `log_msg()` 和 `log_json()` 函数
  - **禁止**直接使用 `print()` 进行调试或日志输出
  - 使用 `log_msg("ERROR", "...")` 记录错误会自动抛出异常

### 4.2 Git 工作流规范

- **版本策略**: 不考虑向后兼容，直接修改原文件。代码简洁性优先。
- **提交规范**: Conventional Commits (`feat:`, `fix:`, `docs:`, `refactor:`)
- **防御性提示**:
  > [!CAUTION]
  > **严禁** 在 commit message 中添加任何 AI 标识
  > 所有提交必须仅显示人类开发者为作者

### 4.3 测试规范

- **必须有测试**: 目标 80% 覆盖率
- **测试位置**: `tests/` 目录
- **测试命名**: `test_<模块名>.py`

---

## 5. 上下文获取与迷途指南 (Context & Navigation)

> **当你感到困惑或需要更多信息时，请参考以下路径：**

| 需求 | 路径 | 说明 |
|------|------|------|
| 了解项目整体目标与背景 | `CLAUDE.md` | 本文件 |
| 了解施工方案 7 大章节标准 | `templates/standard_50502.md` | GB/T 50502-2009 |
| 查看清洗后的数据格式 | `output/1/final.md` | 示例输出 |
| 了解 OCR 清洗工具用法 | `README.md` | 工具说明 |
| 了解工程规范（旧版） | `AGENTS.md` | 已存在的规范 |
| 理清复杂思路 | `draft.md` | 草稿文件（临时） |
| 了解 LangChain 用法 | https://python.langchain.com/docs/ | 官方文档 |
| 了解 LangGraph 用法 | https://langchain-ai.github.io/langgraph/ | 官方文档 |

---

## 6. 输出规范

- **所有输出语言**: **中文**
- **信息密度优先**: 表格 > 伪代码 > 列表 > 大段代码
- 避免大段完整代码和冗长解释
- 代码片段只展示关键部分

---

## 7. 项目功能设计

### 7.1 施工方案检测（审核系统）

**检测维度**：

1. **章节完整性检查**
   - 标准 7 大章节：编制依据、工程概况、施工安排、施工准备、施工方法及工艺要求、施工保证措施、应急预案
   - 允许标题灵活命名，但内容必须覆盖 7 大方面
   - 输出：缺失章节清单 + 完整性评分

2. **编制依据时效性检查**
   - 识别方案引用的规范标准（国标、行标、企标）
   - 对比最新版本，标记过时引用
   - 输出：过时依据清单 + 建议更新版本

3. **合规性检查**
   - 工艺流程、设备配置、人员配备是否符合规范
   - 输出：合规性问题清单 + 规范条款引用

### 7.2 施工方案生成

**生成流程**：
1. 输入工程基本信息
2. 检索相似历史方案（从 16 份优质样本中）
3. 基于 `templates/standard_50502.md` 生成 7 大章节
4. 调用知识库填充内容
5. 风险点识别与保障措施生成

---

## 8. 技术架构

### 8.1 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        输入层                                │
├─────────────────────────────────────────────────────────────┤
│  PDF 文件  ──→  OCR 清洗管道  ──→  Markdown                │
│  Markdown 文件  ──────────────→  直接处理                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    处理层（多智能体系统）                     │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   检测 Agent    │    │   生成 Agent    │                │
│  ├─────────────────┤    ├─────────────────┤                │
│  │ • 章节完整性    │    │ • 信息提取      │                │
│  │ • 依据时效性    │    │ • 内容生成      │                │
│  │ • 合规性检查    │    │ • 质量校验      │                │
│  └─────────────────┘    └─────────────────┘                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        知识层                                │
├─────────────────────────────────────────────────────────────┤
│  ChromaDB          │  LightRAG          │  文件系统         │
│  • 编制依据        │  • 优质方案片段    │  • 标准模板       │
│  • 规范标准        │  • 语义检索        │  • 清洗后数据     │
│  • 审核要点        │                    │                   │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 数据流

```
检测流程: 输入(PDF/MD) → [OCR清洗] → 章节分割 → 知识库检索 → LLM分析 → 检测报告
生成流程: 工程信息 → 模板加载 → 案例检索 → LLM生成 → 质量校验 → 输出方案
```

---

## 9. 数据资源

### 9.1 原始数据
- **位置**: `data/` 目录
- **内容**: 16 份南方电网施工方案 PDF（178MB）

### 9.2 清洗后数据
- **位置**: `output/1-16/final.md`
- **处理流程**: OCR → 正则清洗 → LLM 语义清洗

### 9.3 数据用途
| 用途 | 说明 |
|------|------|
| 优质方案样本 | 施工方案生成的案例/参考 |
| 检测性能测试 | 验证检测系统准确性的金标准 |
| OCR 清洗管道 | 未来系统接收 PDF 输入的前置处理流程 |

---

## 10. 开发路线图

| 阶段 | 时间 | 任务 |
|------|------|------|
| Phase 1 | 已完成 | OCR 转换 + 清洗（16 份 PDF） |
| Phase 2 | 2026-03 | 知识库构建（ChromaDB + LightRAG） |
| Phase 3 | 2026-04 | 施工方案生成 demo |
| Phase 4 | 2026-05~06 | 施工方案审核系统 |
| Phase 5 | 2026-06-30 | 中期检查（报告 + 代码 + 论文 + 专利） |

---

## 11. 待确认问题

1. 现场勘查报告和地质勘查报告怎么做？
2. 人员配置识别的具体要求？
3. 无法分析现场实际人员和设备
4. 5.3/5.4 是否属于系统功能？
5. 李文霸、朱晨旭对接"施工方案过程管理软件"

---

*此文件由睿睿创建，用于为 coding agent 提供完整的项目上下文。遵循 Scientist 的编程规范模板。*
