# K20 å®æ–½è®¡åˆ’ï¼šåµŒå…¥æ¨¡å‹ + Reranker è¯„ä¼°ä¸é€‰å‹

> **ä»»åŠ¡ç¼–å·**: K20
> **å‰ç½®ä¾èµ–**: K16ï¼ˆ692 æ¡ç»“æ„åŒ–çŸ¥è¯†ç‰‡æ®µï¼‰ã€K9ï¼ˆçŸ¥è¯†åº“æ¶æ„è®¾è®¡ï¼Œ8 Collection å®šä¹‰ï¼‰
> **ä¸‹æ¸¸æ¶ˆè´¹è€…**: K23ï¼ˆå‘é‡åº“æ„å»ºï¼‰â†’ S9ï¼ˆVectorStoreï¼‰â†’ S10ï¼ˆKnowledgeRetrieverï¼‰
> **æ—¥æœŸ**: 2026-02-25ï¼ˆæ›´æ–°ï¼‰
> **åŸå§‹ä»»åŠ¡æè¿°**: åµŒå…¥æ¨¡å‹è¯„ä¼°ï¼šbge-m3 vs text2vec ç­‰ï¼Œæ–½å·¥æ–¹æ¡ˆé¢†åŸŸè¯­ä¹‰æ£€ç´¢è¯„æµ‹

---

## å½“å‰è¿›åº¦

| é˜¶æ®µ | çŠ¶æ€ | äº§å‡º |
|------|------|------|
| Phase A: ç¯å¢ƒå‡†å¤‡ | ğŸ”² **æœªå¼€å§‹** | ML ä¾èµ–æœªå®‰è£…ï¼Œæ¨¡å‹æœªä¸‹è½½ |
| Phase B: è¯„æµ‹æ•°æ®é›†æ„é€  | âœ… **å·²å®Œæˆ** | `eval/embedding/eval_dataset.jsonl`ï¼ˆ100 ç»„ï¼‰ |
| Phase C: åµŒå…¥æ¨¡å‹è¯„æµ‹è„šæœ¬ | âœ… **è„šæœ¬å°±ç»ª** | `scripts/eval_embedding_models.py`ï¼ˆ624 è¡Œï¼‰|
| Phase D: Reranker è¯„æµ‹è„šæœ¬ | ğŸ”² **æœªå¼€å§‹** | `scripts/eval_reranker_models.py` å¾…ç¼–å†™ |
| Phase E: è”åˆç®¡é“è¯„æµ‹ | ğŸ”² **æœªå¼€å§‹** | `scripts/eval_combined_pipeline.py` å¾…ç¼–å†™ |
| Phase F: é€‰å‹æŠ¥å‘Š + é›†æˆéªŒè¯ | ğŸ”² **æœªå¼€å§‹** | è¯„æµ‹æŠ¥å‘Š + qmd é›†æˆéªŒè¯ |

**å·²å°±ç»ªèµ„äº§**ï¼š

| èµ„äº§ | ä½ç½® | çŠ¶æ€ |
|------|------|------|
| è¯„æµ‹æ•°æ®é›† | `eval/embedding/eval_dataset.jsonl` | 100 ç»„ query-passage å¯¹ï¼Œ4 ç§ hard negatives |
| æ•°æ®é›†æ„é€ è„šæœ¬ | `scripts/build_eval_dataset.py` | 404 è¡Œï¼Œå·²è¿è¡Œå®Œæ¯• |
| åµŒå…¥è¯„æµ‹è„šæœ¬ | `scripts/eval_embedding_models.py` | 624 è¡Œï¼Œæœªè¿è¡Œï¼ˆå¾…å®‰è£…ä¾èµ–ï¼‰|
| 692 æ¡çŸ¥è¯†ç‰‡æ®µ | `docs/knowledge_base/fragments/fragments.jsonl` | K16 äº§å‡ºï¼Œ1.9MB |

---

## æ‘˜è¦

ä¸ºæ–½å·¥æ–¹æ¡ˆé¢†åŸŸçš„å‘é‡æ£€ç´¢ç®¡é“é€‰å®š**æœ€ä¼˜åµŒå…¥æ¨¡å‹ + Reranker ç»„åˆ**ï¼Œå…¨éƒ¨æœ¬åœ° GPU éƒ¨ç½²ã€‚

æœ¬ä»»åŠ¡ç›´æ¥è§£å†³ `docs/architecture/05-knowledge-base.md` ä¸­åµŒå…¥ç­–ç•¥çš„"å¾…å®š"çŠ¶æ€ï¼š

> **æ¨¡å‹**ï¼šå¾…å®šï¼ˆbge-m3 / text2vec-large-chinese / å…¶ä»–ä¸­æ–‡æ¨¡å‹ï¼‰ã€‚è¯„ä¼°ç»´åº¦ï¼šä¸­æ–‡è¯­ä¹‰ç†è§£èƒ½åŠ›ã€å‘é‡ç»´åº¦ã€æ¨ç†é€Ÿåº¦ã€ä¸ qmd çš„å…¼å®¹æ€§

ä¸»è¦å·¥ä½œï¼š
1. âœ… ä» 692 æ¡çŸ¥è¯†ç‰‡æ®µä¸­æ„é€ **é¢†åŸŸè¯„æµ‹æ•°æ®é›†**ï¼ˆ100 ç»„ query-passage å¯¹ + hard negativesï¼‰
2. å¯¹ **5 ä¸ªå€™é€‰åµŒå…¥æ¨¡å‹**åšå®šé‡è¯„æµ‹ï¼ˆQwen3 ç³»åˆ— + BGE ç³»åˆ—ï¼‰
3. å¯¹ **4 ä¸ªå€™é€‰ Reranker** åšå®šé‡è¯„æµ‹
4. è¯„æµ‹ç»´åº¦ï¼šæ£€ç´¢ç²¾åº¦ï¼ˆMRR@3, Hit@3ï¼‰ã€é•¿æ–‡æœ¬é²æ£’æ€§ã€æ¨ç†é€Ÿåº¦ã€æ˜¾å­˜å ç”¨
5. ç¡®å®š Embedding + Reranker æœ€ä¼˜ç»„åˆï¼Œè¾“å‡ºé€‰å‹æŠ¥å‘Š + ç”Ÿäº§éƒ¨ç½²å‚æ•°

**ä¸ºä»€ä¹ˆè¿™ä¸ªä»»åŠ¡é‡è¦**ï¼šçŸ¥è¯†åº“ 8 ä¸ª Collection çš„æ£€ç´¢è´¨é‡å®Œå…¨ä¾èµ–åµŒå…¥æ¨¡å‹é€‰å‹ã€‚`ch06_methods`ï¼ˆæ–½å·¥æ–¹æ³•ï¼‰åŒ…å« 235 æ¡ä¸“ä¸šç‰‡æ®µï¼Œç‰‡æ®µé•¿åº¦ä» 50 å­—åˆ° 17155 å­—ä¸ç­‰â€”â€”æ¨¡å‹å¿…é¡»åœ¨é•¿çŸ­æ–‡æœ¬ä¸Šéƒ½è¡¨ç°è‰¯å¥½ã€‚

---

## å®¡æŸ¥ç‚¹

> ä»¥ä¸‹é—®é¢˜éœ€è¦åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ç¡®è®¤æˆ–ç•™æ„ï¼š

1. **Qwen3-Embedding-8B æ˜¾å­˜å¯è¡Œæ€§**ï¼šFP16 ç†è®º ~16GBï¼Œä½†æ¨ç†æ—¶ batch å¤„ç†å¯èƒ½äº§ç”Ÿé¢å¤–å ç”¨ã€‚éœ€åœ¨ Phase C å®æµ‹ï¼Œè‹¥è¶…å‡º 24GB åˆ™é€€å› 4B
2. **flash-attn ç¼–è¯‘å…¼å®¹æ€§**ï¼šä¾èµ– CUDA ç‰ˆæœ¬ï¼Œå¯èƒ½éœ€è¦ç‰¹å®š GCC ç‰ˆæœ¬ã€‚å¤‡é€‰æ–¹æ¡ˆï¼šä¸è£… flash-attnï¼Œä½¿ç”¨æ ‡å‡† attentionï¼ˆé€Ÿåº¦æ…¢ä½†åŠŸèƒ½ä¸å—å½±å“ï¼‰
3. **è¯„æµ‹æ•°æ®é›†ä¸­ 30 ç»„äººå·¥æ ¡éªŒ**ï¼šå½“å‰ 100 ç»„å…¨éƒ¨ `human_verified: false`ã€‚è®¡åˆ’ä¸­è¦æ±‚äººå·¥æ ¡éªŒ 30 ç»„ï¼Œä½† MVP é˜¶æ®µå¯å…ˆè·³è¿‡ï¼Œå¾…è¯„æµ‹ç»“æœå‡ºæ¥åè§†éœ€è¦è¡¥å……
4. **qmd ä¸ sentence-transformers â‰¥2.7.0 å…¼å®¹æ€§**ï¼šqmd 0.1.0 çš„ `SentenceTransformerBackend` å†…éƒ¨ä¹Ÿä¾èµ– sentence-transformersï¼Œéœ€ç¡®è®¤ç‰ˆæœ¬çº¦æŸä¸å†²çª
5. **Qwen3 Embedding çš„ instruction æ¨¡å¼**ï¼šQwen3 æ”¯æŒ `prompt_name="query"` è‡ªå®šä¹‰æŒ‡ä»¤ï¼Œå¯èƒ½éœ€è¦æ¢ç´¢æ–½å·¥æ–¹æ¡ˆé¢†åŸŸä¸“ç”¨ instruction æ˜¯å¦èƒ½è¿›ä¸€æ­¥æå‡

---

## ç°çŠ¶åˆ†æ

### ç¯å¢ƒæ¡ä»¶

| èµ„æº | è§„æ ¼ |
|------|------|
| GPU | **NVIDIA RTX 4090 (24GB VRAM)** |
| CPU | Intel i9-13900K |
| å†…å­˜ | 64GB |
| Python | 3.10 (conda: sca) |
| qmd | 0.1.0ï¼ˆå·²è£…ï¼‰ï¼Œå« `SentenceTransformerBackend`ï¼ˆåµŒå…¥ï¼‰ã€`FlagEmbeddingBackend`ï¼ˆrerankï¼‰ |
| sqlite-vec | 0.1.6ï¼ˆå·²è£…ï¼‰ |
| ML ä¾èµ– | **æœªè£…**ï¼šnumpy, torch, sentence-transformers, transformers |

### å·²æœ‰èµ„äº§

| èµ„äº§ | ä½ç½® | è¯´æ˜ |
|------|------|------|
| 692 æ¡çŸ¥è¯†ç‰‡æ®µ | `docs/knowledge_base/fragments/fragments.jsonl` | å«å®Œæ•´å…ƒæ•°æ®ï¼ˆç« èŠ‚ã€å·¥ç¨‹ç±»å‹ã€æ ‡ç­¾ã€å­—æ•°ã€å¯†åº¦ï¼‰ |
| qmd åµŒå…¥æ¥å£ | `qmd.llm.sentence_tf.SentenceTransformerBackend` | æ¥å—ä»»æ„ HuggingFace æ¨¡å‹åï¼Œæ”¯æŒ `embed()` / `embed_batch()` |
| qmd Rerank æ¥å£ | `qmd.llm.flagembed.FlagEmbeddingBackend` | åŸºäº `FlagReranker`ï¼Œcross-encoder é‡æ’åº |
| qmd æ£€ç´¢å¼•æ“ | `qmd.core.retrieval` | BM25 + å‘é‡ + RRF æ··åˆæ£€ç´¢ |
| 8 Collection è®¾è®¡ | `docs/architecture/05-knowledge-base.md` | ch01_basis ~ templatesï¼ŒæŒ‰ç« èŠ‚åˆ†åº“ |
| è¯„æµ‹æ•°æ®é›† | `eval/embedding/eval_dataset.jsonl` | 100 ç»„ query-passage å¯¹ |

### çŸ¥è¯†ç‰‡æ®µç»Ÿè®¡ï¼ˆè¯„æµ‹çš„åŸºç¡€æ•°æ®ï¼‰

```
æ€»æ•°: 692 | å­—ç¬¦èŒƒå›´: 0-17155 | ä¸­ä½æ•°: 267 | å¹³å‡: 489
P90: 992 | P95: 1442 | P99: 4723
>512å­—: 167 (24%) | >1024å­—: 66 (10%) | >2048å­—: 15 (2%)

Top å·¥ç¨‹ç±»å‹: å˜ç”µåœŸå»º 203 | çº¿è·¯å¡”åŸº 159 | å˜ç”µç”µæ°” 74 | ä¸“é¢˜æ–¹æ¡ˆ 66
Top æ ‡ç­¾: æ··å‡åœŸ 131 | é’¢ç­‹ 92 | éªŒæ”¶ 61 | æ¨¡æ¿ 61 | æµ‡ç­‘ 52
```

### è¯„æµ‹æ•°æ®é›†ç»Ÿè®¡ï¼ˆPhase B äº§å‡ºï¼‰

```
æ€»ç»„æ•°: 100 | æŒ‰ç« èŠ‚åˆ†å¸ƒ:
  Ch1 ç¼–åˆ¶ä¾æ®: 5   | Ch2 å·¥ç¨‹æ¦‚å†µ: 3   | Ch3 ç»„ç»‡æœºæ„: 3
  Ch4 æ–½å·¥å®‰æ’: 4   | Ch5 æ–½å·¥å‡†å¤‡: 8   | Ch6 æ–½å·¥æ–¹æ³•: 30
  Ch7 è´¨é‡ç®¡ç†: 15  | Ch8 å®‰å…¨ç®¡ç†: 15  | Ch9 åº”æ€¥é¢„æ¡ˆ: 12
  Ch10 ç»¿è‰²æ–½å·¥: 5
é•¿æ–‡æœ¬è¦†ç›–: >512å­— â‰¥15 æ¡, >1024å­— â‰¥5 æ¡
Hard negatives: æ¯ç»„ 4 ä¸ªï¼ˆsame_chapter_diff_eng / diff_chapter_same_eng / same_chapter_same_eng / randomï¼‰
```

---

## å€™é€‰æ¨¡å‹

### A. åµŒå…¥æ¨¡å‹ï¼ˆ5 ä¸ªå€™é€‰ï¼‰

åŸºäº MTEB / C-MTEB æœ€æ–°æ’å + ä¸­æ–‡èƒ½åŠ› + æœ¬åœ° GPU å¯è¡Œæ€§ç­›é€‰ï¼š

| # | æ¨¡å‹ | å‚æ•°é‡ | ç»´åº¦ | æœ€å¤§ token | FP16 æ˜¾å­˜ | C-MTEB Mean | ç‰¹ç‚¹ |
|---|------|--------|------|-----------|----------|-------------|------|
| E1 | `Qwen/Qwen3-Embedding-8B` | 8B | 1024 | 32K | ~16GB | **73.84** | MTEB å¤šè¯­è¨€æ¦œé¦– (70.58)ï¼Œä¸­æ–‡ SOTA |
| E2 | `Qwen/Qwen3-Embedding-4B` | 4B | 1024 | 32K | ~8GB | **72.27** | è´¨é‡/æ•ˆç‡å¹³è¡¡ç‚¹ |
| E3 | `Qwen/Qwen3-Embedding-0.6B` | 0.6B | 1024 | 32K | ~1.5GB | **66.33** | è½»é‡ä½†æ˜¾è‘—ä¼˜äº BGE-M3 |
| E4 | `BAAI/bge-m3` | 0.6B | 1024 | 8K | ~1.5GB | 59.56 | æˆç†Ÿç¨³å®šï¼ŒDense+Sparse+ColBERT ä¸‰æ¨¡æ€ |
| E5 | `BAAI/bge-large-zh-v1.5` | 0.3B | 1024 | 512 | ~0.7GB | ~63* | ä¸­æ–‡ä¸“ç”¨åŸºçº¿ï¼Œ512 token çª—å£éªŒè¯é•¿æ–‡æœ¬è¡°å‡ |

> \* bge-large-zh-v1.5 çš„ C-MTEB åˆ†æ•°ä¸ºæ—©æœŸç‰ˆæœ¬åŸºå‡†ï¼Œä¸ä¸ Qwen3 ç³»åˆ—ç›´æ¥å¯æ¯”ã€‚

**C-MTEB æ£€ç´¢å­ä»»åŠ¡å¯¹æ¯”**ï¼ˆå¯¹æœ¬é¡¹ç›®æœ€å…³é”®çš„æŒ‡æ ‡ï¼‰ï¼š

| æ¨¡å‹ | C-MTEB Retrieval | å·®è· |
|------|------------------|------|
| Qwen3-Embedding-8B | 78.21 | baseline |
| Qwen3-Embedding-4B | 77.03 | -1.18 |
| Qwen3-Embedding-0.6B | 71.03 | -7.18 |
| BGE-M3 | 80.76* | â€” |

> \* BGE-M3 åœ¨æ£€ç´¢å­ä»»åŠ¡ä¸Šçš„é«˜åˆ†éƒ¨åˆ†å› å…¶ Dense+Sparse æ··åˆæ£€ç´¢ä¼˜åŠ¿ï¼Œå•ç‹¬ Dense åˆ†æ•°ç•¥ä½ã€‚

**å…³é”®ä¼˜åŠ¿å¯¹æ¯”**ï¼š

| ç»´åº¦ | Qwen3 ç³»åˆ— | BGE-M3 |
|------|-----------|--------|
| ä¸Šä¸‹æ–‡çª—å£ | 32K tokenï¼ˆè¦†ç›–å…¨éƒ¨ç‰‡æ®µï¼‰ | 8K tokenï¼ˆè¦†ç›– 99% ç‰‡æ®µï¼‰ |
| ä¸­æ–‡ä¸“é¡¹èƒ½åŠ› | C-MTEB å…¨ä»»åŠ¡å¤§å¹…é¢†å…ˆ | å¤šè¯­è¨€æ³›åŒ–ï¼Œä¸­æ–‡æ¬¡ä¼˜ |
| æŒ‡ä»¤æ„ŸçŸ¥ | âœ… æ”¯æŒè‡ªå®šä¹‰ instructionï¼ˆ+1~5%ï¼‰ | âŒ |
| ç»´åº¦å¯è°ƒ | 32-1024 çµæ´»é…ç½® | å›ºå®š 1024 |
| æ··åˆæ£€ç´¢ | ä»… Dense | Dense + Sparse + ColBERT |
| sentence-transformers | âœ… â‰¥2.7.0 | âœ… |

### B. Reranker æ¨¡å‹ï¼ˆ4 ä¸ªå€™é€‰ï¼‰

| # | æ¨¡å‹ | å‚æ•°é‡ | æœ€å¤§ token | FP16 æ˜¾å­˜ | CMTEB-R | ç‰¹ç‚¹ |
|---|------|--------|-----------|----------|---------|------|
| R1 | `Qwen/Qwen3-Reranker-4B` | 4B | 32K | ~8GB | **75.94** | è´¨é‡/æ˜¾å­˜æœ€ä¼˜å¹³è¡¡ç‚¹ |
| R2 | `Qwen/Qwen3-Reranker-0.6B` | 0.6B | 32K | ~1.5GB | 71.31 | è½»é‡ï¼Œä¸ Embedding æ˜¾å­˜äº’è¡¥ |
| R3 | `Qwen/Qwen3-Reranker-8B` | 8B | 32K | ~16GB | **77.45** | CMTEB-R æœ€é«˜åˆ† |
| R4 | `BAAI/bge-reranker-v2-m3` | 0.6B | 8K | ~1.5GB | ~68* | qmd å·²æœ‰ `FlagEmbeddingBackend` æ”¯æŒ |

> \* bge-reranker-v2-m3 çš„ CMTEB-R ä¸ºä¼°è®¡å€¼ï¼ŒåŸºäºå…¬å¼€åŸºå‡†æ¨ç®—ã€‚

### C. ç”Ÿäº§éƒ¨ç½²æ˜¾å­˜é¢„ç®—ï¼ˆEmbedding + Reranker éœ€åŒæ—¶åŠ è½½ï¼‰

| ç»„åˆ | Embedding æ˜¾å­˜ | Reranker æ˜¾å­˜ | æ€»è®¡ | RTX 4090 (24GB) |
|------|---------------|-------------|------|-----------------|
| E1+R3 (8B+8B) | 16GB | 16GB | 32GB | âŒ è¶…å‡º |
| E1+R1 (8B+4B) | 16GB | 8GB | 24GB | âš ï¸ æé™ï¼Œæ— ä½™é‡ |
| E1+R2 (8B+0.6B) | 16GB | 1.5GB | 17.5GB | âœ… ä½™é‡ 6.5GB |
| E2+R1 (4B+4B) | 8GB | 8GB | 16GB | âœ… ä½™é‡ 8GB |
| E2+R2 (4B+0.6B) | 8GB | 1.5GB | 9.5GB | âœ… ä½™é‡ 14.5GB |
| E3+R1 (0.6B+4B) | 1.5GB | 8GB | 9.5GB | âœ… ä½™é‡ 14.5GB |
| E4+R4 (bge å…¨å®¶æ¡¶) | 1.5GB | 1.5GB | 3GB | âœ… ä½™é‡ 21GB |

> **å…³é”®çº¦æŸ**ï¼šè¯„æµ‹é˜¶æ®µé€ä¸ªåŠ è½½æ— æ˜¾å­˜é—®é¢˜ï¼›**ç”Ÿäº§éƒ¨ç½²**æ—¶ä¸¤æ¨¡å‹å¿…é¡»å…±å­˜ï¼Œéœ€åœ¨è¯„æµ‹æŠ¥å‘Šä¸­ç»™å‡ºå¯è¡Œç»„åˆæ¨èã€‚

---

## è¯„æµ‹æ–¹æ¡ˆè®¾è®¡

### æ ¸å¿ƒæ€è·¯

```
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  692 æ¡çŸ¥è¯†ç‰‡æ®µ (passages)         â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ LLM è‡ªåŠ¨ç”ŸæˆæŸ¥è¯¢ï¼ˆå·²å®Œæˆï¼‰
                                      â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  è¯„æµ‹æ•°æ®é›† (100 ç»„ query-passage å¯¹)    â”‚
                    â”‚  æ¯ç»„: query + positive + 4 hard neg    â”‚
                    â”‚  ä½ç½®: eval/embedding/eval_dataset.jsonl â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                â–¼                 â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Phase C: åµŒå…¥   â”‚ â”‚ Phase D:     â”‚ â”‚ Phase E: è”åˆ    â”‚
     â”‚ 5 æ¨¡å‹ Ã— æŒ‡æ ‡   â”‚ â”‚ Reranker     â”‚ â”‚ Embedding+Rerank â”‚
     â”‚ MRR/Hit/é€Ÿåº¦    â”‚ â”‚ 4 æ¨¡å‹ Ã— æŒ‡æ ‡ â”‚ â”‚ æœ€ä¼˜ç»„åˆå¯¹æ¯”     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                â”‚                   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ é€‰å‹æŠ¥å‘Š + éƒ¨ç½²é…ç½®       â”‚
                    â”‚ æ›´æ–° 05-knowledge-base.md â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¯„æµ‹æ•°æ®é›†ï¼ˆâœ… å·²å®Œæˆï¼‰

å·²ä» 692 æ¡ç‰‡æ®µä¸­æŒ‰**ç« èŠ‚ Ã— å·¥ç¨‹ç±»å‹**åˆ†å±‚æŠ½æ · 100 ç»„ query-passage å¯¹ã€‚

æ•°æ®é›†æ„é€ æ–¹æ³•ï¼š
1. æŒ‰ 10 ç« èŠ‚é…é¢åˆ†å±‚æŠ½æ ·ï¼ˆCh6 æ–½å·¥æ–¹æ³• 30 æ¡å æœ€å¤šï¼Œä¸å®é™…æ£€ç´¢éœ€æ±‚åŒ¹é…ï¼‰
2. é•¿æ–‡æœ¬ä¿éšœï¼ˆâ‰¥15 æ¡ >512 å­—ï¼Œâ‰¥5 æ¡ >1024 å­—ï¼‰
3. LLMï¼ˆDeepSeekï¼‰ç”Ÿæˆæ¨¡æ‹Ÿå·¥ç¨‹å¸ˆæ£€ç´¢æ„å›¾çš„æŸ¥è¯¢ï¼ˆ15-40 å­—ï¼Œä¸“ä¸šæœ¯è¯­ä½†å£è¯­åŒ–ï¼‰
4. è‡ªåŠ¨æ„é€  4 ç±» hard negativesï¼ˆåŒç« èŠ‚ä¸åŒå·¥ç¨‹ã€ä¸åŒç« èŠ‚ç›¸åŒå·¥ç¨‹ã€åŒç« èŠ‚åŒå·¥ç¨‹ä¸åŒå†…å®¹ã€éšæœºï¼‰

**æ•°æ®æ ¼å¼**ï¼š

```json
{
  "query_id": "q001",
  "query": "å®¤å†…è†¨èƒ€å‹é’¢ç»“æ„é˜²ç«æ¶‚æ–™GT-NSP-Fp1.50-HBçš„è€ç«æ€§èƒ½æ£€æµ‹ç»“æœ...",
  "positive_id": "doc03_ch1_s04",
  "positive_chapter": "ä¸€ã€ç¼–åˆ¶ä¾æ®",
  "positive_engineering_type": "æ¶‚è£…å·¥ç¨‹",
  "positive_char_count": 780,
  "hard_negatives": [
    {"id": "doc10_ch1_s01", "type": "same_chapter_diff_eng"},
    {"id": "doc02_ch6_s07", "type": "diff_chapter_same_eng"},
    {"id": "doc03_ch1_s01", "type": "same_chapter_same_eng"},
    {"id": "doc06_ch7_s14", "type": "random"}
  ],
  "human_verified": false
}
```

### è¯„æµ‹æŒ‡æ ‡

#### åµŒå…¥æ¨¡å‹æŒ‡æ ‡

| æŒ‡æ ‡ | å®šä¹‰ | ç›®æ ‡ |
|------|------|------|
| **MRR@3** | top-3 ä¸­æ­£ç¡®ç»“æœçš„å€’æ•°æ’åå‡å€¼ | â‰¥ 0.80 |
| **Hit@1** | top-1 å‘½ä¸­ç‡ | â‰¥ 0.70 |
| **Hit@3** | top-3 å‘½ä¸­ç‡ | â‰¥ 0.90 |
| **Hit@10** | top-10 å‘½ä¸­ç‡ï¼ˆReranker çš„å¬å›æ± ï¼‰ | â‰¥ 0.95 |
| **Hard Neg åŒºåˆ†åº¦** | positive ä¸ hard negative çš„å¹³å‡ score å·® | è¶Šå¤§è¶Šå¥½ |
| **é•¿æ–‡æœ¬ MRR@3** | >1024 å­—ç‰‡æ®µçš„ MRR@3 | è®°å½•ä¸å…¨é‡çš„å·®å€¼ |
| **æ¨ç†é€Ÿåº¦** | å•æ¡åµŒå…¥å»¶è¿Ÿï¼ˆms, GPUï¼‰ | è®°å½• |
| **batch åå** | 692 æ¡å…¨é‡åµŒå…¥è€—æ—¶ï¼ˆsï¼‰ | è®°å½• |
| **æ˜¾å­˜å³°å€¼** | æ¨ç†æ—¶ GPU æ˜¾å­˜å ç”¨ | è®°å½• |

#### Reranker æŒ‡æ ‡

| æŒ‡æ ‡ | å®šä¹‰ | ç›®æ ‡ |
|------|------|------|
| **Rerank MRR@3** | Embedding å¬å› top-10 åï¼ŒReranker é‡æ’çš„ MRR@3 | â‰¥ 0.85 |
| **Rerank Hit@1** | é‡æ’å top-1 å‘½ä¸­ç‡ | â‰¥ 0.80 |
| **Rerank Hit@3** | é‡æ’å top-3 å‘½ä¸­ç‡ | â‰¥ 0.95 |
| **MRR å¢ç›Š** | Rerank MRR@3 - Embedding MRR@3 | è¶Šå¤§è¶Šå¥½ |
| **å• query å»¶è¿Ÿ** | å¯¹ 10 ä¸ªå€™é€‰é‡æ’çš„å»¶è¿Ÿï¼ˆmsï¼‰ | è®°å½• |
| **æ˜¾å­˜å³°å€¼** | æ¨ç†æ—¶ GPU æ˜¾å­˜å ç”¨ | è®°å½• |

#### è”åˆç®¡é“æŒ‡æ ‡ï¼ˆEmbedding + Rerankerï¼‰

| æŒ‡æ ‡ | å®šä¹‰ |
|------|------|
| **ç«¯åˆ°ç«¯ MRR@3** | Embedding å¬å› â†’ Reranker é‡æ’ â†’ top-3 |
| **ç«¯åˆ°ç«¯å»¶è¿Ÿ** | å•æ¬¡ query ä»åµŒå…¥åˆ°é‡æ’å‡ºç»“æœçš„æ€»å»¶è¿Ÿ |
| **ç»„åˆæ˜¾å­˜** | ä¸¤æ¨¡å‹åŒæ—¶åŠ è½½çš„æ˜¾å­˜æ€»å ç”¨ |

### è¯„æµ‹ä¸ 8 Collection è®¾è®¡çš„å…³ç³»

è¯„æµ‹ç»“æœå°†ç›´æ¥å½±å“ `05-knowledge-base.md` ä¸­ 8 ä¸ª Collection çš„æ£€ç´¢å‚æ•°ï¼š

| Collection | ä¸»è¦æ£€ç´¢åœºæ™¯ | å¯¹åµŒå…¥æ¨¡å‹çš„å…³é”®è¦æ±‚ |
|-----------|------------|-------------------|
| `ch01_basis` | æ ‡å‡†ç¼–å·ç²¾å‡†åŒ¹é… | ç²¾ç¡®æ£€ç´¢ï¼ˆéè¯­ä¹‰æ£€ç´¢ï¼‰ï¼Œå¯èƒ½éœ€è¦ BM25 è¾…åŠ© |
| `ch06_methods` | æŒ‰å·¥ç¨‹ç±»å‹æ£€ç´¢æ–½å·¥å·¥è‰º | **é•¿æ–‡æœ¬èƒ½åŠ›**ï¼ˆ6 æˆç‰‡æ®µ >500 å­—ï¼‰+ å·¥ç¨‹æœ¯è¯­è¯­ä¹‰ç†è§£ |
| `ch07_quality` | æŒ‰å·¥åºæ£€ç´¢è´¨é‡æ§åˆ¶ç‚¹ | è¿‘ä¹‰è¯åŒºåˆ†ï¼ˆå¦‚ "éªŒæ”¶" vs "æ£€éªŒ" vs "æ£€æŸ¥"ï¼‰ |
| `ch08_safety` | æŒ‰å·¥åºæ£€ç´¢å®‰å…¨æªæ–½ | ä¸ ch07 ç›¸ä¼¼ç‰‡æ®µçš„**åŒºåˆ†åº¦**ï¼ˆåŒå·¥ç¨‹ç±»å‹è·¨ç« èŠ‚ï¼‰ |
| `ch09_emergency` | æŒ‰äº‹æ•…ç±»å‹æ£€ç´¢å¤„ç½®æ–¹æ³• | ä¸“ä¸šæœ¯è¯­åŒ¹é…ï¼ˆè§¦ç”µã€åå¡Œã€é«˜å¤„å è½ç­‰ï¼‰ |
| `equipment` | æŒ‰è®¾å¤‡ç±»å‹æ£€ç´¢å‚æ•° | æ•°å€¼+å‹å·ç²¾å‡†åŒ¹é… |
| `templates` | é€šç”¨æ¨¡æ¿æ®µè½æ£€ç´¢ | ä½è¦æ±‚ï¼ˆé«˜åº¦æ¨¡æ¿åŒ–å†…å®¹ï¼‰ |

è¯„æµ‹æŠ¥å‘Šä¸­éœ€æŒ‰ç« èŠ‚ç»´åº¦åˆ†æå„æ¨¡å‹è¡¨ç°ï¼Œç›´æ¥æŒ‡å¯¼å“ªäº› Collection é€‚åˆçº¯å‘é‡æ£€ç´¢ã€å“ªäº›éœ€è¦ BM25+å‘é‡æ··åˆã€‚

---

## æ‹Ÿè®®å˜æ›´

### é˜¶æ®µ Aï¼šç¯å¢ƒå‡†å¤‡ [MODIFY]

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `requirements.txt` | [MODIFY] | æ–°å¢ ML ä¾èµ– |

**æ–°å¢ä¾èµ–**ï¼š

```
torch>=2.0
sentence-transformers>=2.7.0
transformers>=4.51.0
numpy>=1.24
scipy>=1.10
flash-attn>=2.0
```

**å®‰è£…å‘½ä»¤**ï¼š

```bash
# å¤‡ä»½å½“å‰ä¾èµ–
conda run -n sca pip freeze > backup_requirements.txt

# GPU ç‰ˆ torchï¼ˆCUDA 12.1ï¼‰
conda run -n sca pip install torch --index-url https://download.pytorch.org/whl/cu121

# sentence-transformers + transformersï¼ˆQwen3 éœ€è¦ â‰¥4.51ï¼‰
conda run -n sca pip install "sentence-transformers>=2.7.0" "transformers>=4.51.0"

# æ•°å€¼è®¡ç®—
conda run -n sca pip install numpy scipy

# Flash Attention 2ï¼ˆQwen3 æ¨èï¼Œå‡å°‘æ˜¾å­˜ + åŠ é€Ÿï¼‰
conda run -n sca pip install flash-attn --no-build-isolation
```

**æ¨¡å‹ä¸‹è½½**ï¼ˆä½¿ç”¨ hf-mirror.com é•œåƒåŠ é€Ÿï¼‰ï¼š

```bash
export HF_ENDPOINT=https://hf-mirror.com

# åµŒå…¥æ¨¡å‹ï¼ˆ~28GB æ€»è®¡ï¼‰
huggingface-cli download Qwen/Qwen3-Embedding-8B    # ~16GB
huggingface-cli download Qwen/Qwen3-Embedding-4B    # ~8GB
huggingface-cli download Qwen/Qwen3-Embedding-0.6B  # ~1.5GB
huggingface-cli download BAAI/bge-m3                 # ~2.2GB
huggingface-cli download BAAI/bge-large-zh-v1.5      # ~1.3GB

# Reranker æ¨¡å‹ï¼ˆ~11GB æ€»è®¡ï¼‰
huggingface-cli download Qwen/Qwen3-Reranker-4B     # ~8GB
huggingface-cli download Qwen/Qwen3-Reranker-0.6B   # ~1.5GB
huggingface-cli download Qwen/Qwen3-Reranker-8B     # ~16GBï¼ˆå¯é€‰ï¼Œæ˜¾å­˜å…è®¸æ—¶è¯„æµ‹ï¼‰
huggingface-cli download BAAI/bge-reranker-v2-m3     # ~1.2GB
```

### é˜¶æ®µ Bï¼šè¯„æµ‹æ•°æ®é›†æ„é€  [å·²å®Œæˆ]

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `scripts/build_eval_dataset.py` | âœ… å·²å®Œæˆ | 404 è¡Œï¼Œåˆ†å±‚æŠ½æ · + LLM æŸ¥è¯¢ç”Ÿæˆ + hard negatives |
| `eval/embedding/eval_dataset.jsonl` | âœ… å·²å®Œæˆ | 100 ç»„ query-passage å¯¹ |

### é˜¶æ®µ Cï¼šåµŒå…¥æ¨¡å‹è¯„æµ‹ [è„šæœ¬å°±ç»ªï¼Œå¾…è¿è¡Œ]

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `scripts/eval_embedding_models.py` | âœ… å·²å®Œæˆ | 624 è¡Œï¼Œ5 æ¨¡å‹è¯„æµ‹ + æŠ¥å‘Šç”Ÿæˆ |
| `eval/embedding/results/` | [NEW] | è¯„æµ‹ç»“æœç›®å½•ï¼ˆè¿è¡Œåäº§å‡ºï¼‰ |

**å·²å®ç°çš„è¯„æµ‹ç»´åº¦**ï¼š
- å…¨é‡æŒ‡æ ‡ï¼šMRR@1, MRR@3, Hit@1, Hit@3, Hit@10, Hard Neg åŒºåˆ†åº¦
- æŒ‰ç« èŠ‚ï¼š10 ç« èŠ‚å„è‡ªçš„ MRR@3
- æŒ‰é•¿åº¦ï¼š<512 / 512-1024 / >1024 å­—åˆ†å±‚ MRR@3 + Hit@3
- æ€§èƒ½ï¼šå•æ¡å»¶è¿Ÿ(ms)ã€batch åµŒå…¥(s)ã€æ˜¾å­˜å³°å€¼(MB)
- top-10 å¬å›ç»“æœä¿å­˜ï¼ˆä¾› Phase D Reranker å¤ç”¨ï¼‰

**è„šæœ¬äº§å‡º**ï¼š
- `eval/embedding/results/embedding_report.md` â€” ç»¼åˆæ’å + åˆ†å±‚åˆ†æ
- `eval/embedding/results/result_{model_short}.json` â€” å„æ¨¡å‹è¯¦ç»†ç»“æœ
- `eval/embedding/results/top10_{model_short}.jsonl` â€” top-10 å¬å›ç»“æœ

### é˜¶æ®µ Dï¼šReranker è¯„æµ‹ [NEW]

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `scripts/eval_reranker_models.py` | [NEW] | ~280 è¡Œ |

**`RerankerEvaluator` æ ¸å¿ƒæ–¹æ³•**ï¼š

```python
def evaluate_reranker(
    reranker_config: dict,
    top10_results: list[dict],   # Phase C äº§å‡ºçš„ top-10 å¬å›
    fragments: list[dict],
    eval_dataset: list[dict],
) -> RerankerEvalResult:
    """è¯„æµ‹å•ä¸ª Rerankerã€‚

    æµç¨‹ï¼šåŠ è½½ Reranker â†’ å¯¹ 100 ç»„ query çš„ top-10 å€™é€‰é‡æ’ â†’ è®¡ç®—æŒ‡æ ‡ â†’ é‡Šæ”¾æ˜¾å­˜ã€‚
    """

def compute_rerank_metrics(
    reranked_results: list[dict],
    eval_dataset: list[dict],
) -> dict:
    """è®¡ç®— Rerank MRR@3, Hit@1, Hit@3, MRR å¢ç›Šã€‚"""

def benchmark_rerank_speed(reranker, sample_pairs: list) -> dict:
    """æµ‹é€Ÿï¼šå• query é‡æ’ 10 ä¸ªå€™é€‰çš„å»¶è¿Ÿ + æ˜¾å­˜å³°å€¼ã€‚"""
```

**Reranker è¯„æµ‹ä¾èµ– Embedding ç»“æœ**ï¼š
- ä½¿ç”¨ Phase C ä¸­**æœ€ä¼˜åµŒå…¥æ¨¡å‹**çš„ top-10 å¬å›ç»“æœä½œä¸º Reranker è¾“å…¥
- å¦‚æœ Phase C å‡ºç°æ„å¤–ç»“æœï¼ˆå¦‚ BGE-M3 åœ¨ç‰¹å®šç« èŠ‚åè¶…ï¼‰ï¼Œåˆ™åŒæ—¶ç”¨ top-2 Embedding çš„å¬å›ç»“æœåˆ†åˆ«è¯„æµ‹

### é˜¶æ®µ Eï¼šè”åˆç®¡é“è¯„æµ‹ [NEW]

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `scripts/eval_combined_pipeline.py` | [NEW] | ~150 è¡Œ |

```python
def evaluate_combined_pipeline(
    embedding_config: dict,
    reranker_config: dict,
    eval_dataset: list[dict],
    fragments: list[dict],
) -> CombinedEvalResult:
    """è¯„æµ‹ Embedding + Reranker ç»„åˆã€‚

    åŒæ—¶åŠ è½½ä¸¤ä¸ªæ¨¡å‹ï¼Œæµ‹é‡ï¼š
      1. ç«¯åˆ°ç«¯ MRR@3ï¼ˆEmbed â†’ top-10 â†’ Rerank â†’ top-3ï¼‰
      2. ç«¯åˆ°ç«¯å• query å»¶è¿Ÿ
      3. ç»„åˆæ˜¾å­˜å ç”¨
    """
```

é€‰å– top-2 Embedding Ã— top-2 Reranker = 4 ç§ç»„åˆï¼ŒéªŒè¯ï¼š
- ç«¯åˆ°ç«¯æ£€ç´¢ç²¾åº¦
- ä¸¤æ¨¡å‹åŒæ—¶åŠ è½½çš„æ˜¾å­˜æ˜¯å¦åœ¨ 24GB å†…
- ç”Ÿäº§éƒ¨ç½²å¯è¡Œæ€§

### é˜¶æ®µ Fï¼šé€‰å‹æŠ¥å‘Š + é›†æˆéªŒè¯ [NEW + MODIFY]

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|------|------|------|
| `eval/embedding/results/eval_report.md` | [NEW] | å®Œæ•´è¯„æµ‹æŠ¥å‘Šï¼ˆ~200 è¡Œï¼‰|
| `scripts/verify_qmd_integration.py` | [NEW] | qmd ç«¯åˆ°ç«¯é›†æˆéªŒè¯ï¼ˆ~130 è¡Œï¼‰|
| `docs/architecture/05-knowledge-base.md` | [MODIFY] | æ›´æ–°åµŒå…¥æ¨¡å‹é€‰å‹å†³ç­–ï¼ˆ~20 è¡Œï¼‰|
| `docs/PROJECT_OVERVIEW.md` | [MODIFY] | æ›´æ–° K20 çŠ¶æ€ä¸º âœ…ï¼ˆ~5 è¡Œï¼‰|

**qmd é›†æˆéªŒè¯å†…å®¹**ï¼š

```python
def verify_qmd_integration(
    embedding_model: str,
    reranker_model: str,
) -> None:
    """éªŒè¯é€‰å®šæ¨¡å‹ç»„åˆä¸ qmd çš„ç«¯åˆ°ç«¯é›†æˆã€‚

    éªŒè¯é¡¹ï¼š
      1. SentenceTransformerBackend èƒ½åŠ è½½é€‰å®šåµŒå…¥æ¨¡å‹
      2. embed() / embed_batch() è¿”å›æ­£ç¡®ç»´åº¦å‘é‡
      3. sqlite-vec èƒ½å­˜å‚¨å’Œæ£€ç´¢è¯¥ç»´åº¦çš„å‘é‡
      4. FlagEmbeddingBackend èƒ½å¯¹ query + candidates é‡æ’åº
      5. ç«¯åˆ°ç«¯æµç¨‹ï¼šembed â†’ store â†’ search â†’ rerank â†’ è¿”å›ç»“æœ
      6. ä¸¤æ¨¡å‹åŒæ—¶åŠ è½½çš„æ˜¾å­˜éªŒè¯
    """
```

**05-knowledge-base.md æ›´æ–°å†…å®¹**ï¼š

å°†ç¬¬ 41 è¡Œçš„ï¼š
```
- **æ¨¡å‹**ï¼šå¾…å®šï¼ˆbge-m3 / text2vec-large-chinese / å…¶ä»–ä¸­æ–‡æ¨¡å‹ï¼‰
```
æ›¿æ¢ä¸ºè¯„æµ‹ç»“è®ºï¼Œæ ¼å¼å¦‚ï¼š
```
- **æ¨¡å‹**ï¼š{é€‰å®šæ¨¡å‹}ï¼ˆK20 è¯„æµ‹é€‰å®šï¼ŒMRR@3={åˆ†æ•°}ï¼Œæ˜¾å­˜={å ç”¨}MBï¼‰
- **Reranker**ï¼š{é€‰å®šReranker}ï¼ˆRerank MRR@3={åˆ†æ•°}ï¼Œç»„åˆæ˜¾å­˜={æ€»å ç”¨}GBï¼‰
```

**è¯„æµ‹æŠ¥å‘Šæ¨¡æ¿**ï¼š

```markdown
# åµŒå…¥æ¨¡å‹ + Reranker è¯„æµ‹æŠ¥å‘Š

> è¯„æµ‹æ—¥æœŸ | æ•°æ®é›† 100 ç»„ | å…¨é‡ 692 æ¡ | RTX 4090

## ä¸€ã€åµŒå…¥æ¨¡å‹ç»¼åˆæ’å

| # | æ¨¡å‹ | MRR@3 | Hit@1 | Hit@3 | Hit@10 | åŒºåˆ†åº¦ | å»¶è¿Ÿ(ms) | batch(s) | æ˜¾å­˜(MB) |
|---|------|-------|-------|-------|--------|--------|---------|---------|---------|

### 1.1 é•¿æ–‡æœ¬è¡°å‡åˆ†æ
### 1.2 æŒ‰ç« èŠ‚ç»†ç²’åº¦åˆ†æï¼ˆå¯¹åº” 8 Collection æ£€ç´¢è´¨é‡ï¼‰

## äºŒã€Reranker ç»¼åˆæ’å

| # | æ¨¡å‹ | Rerank MRR@3 | Hit@1 | Hit@3 | MRRå¢ç›Š | å»¶è¿Ÿ(ms) | æ˜¾å­˜(MB) |
|---|------|-------------|-------|-------|--------|---------|---------|

## ä¸‰ã€è”åˆç®¡é“æœ€ä¼˜ç»„åˆ

| # | ç»„åˆ | ç«¯åˆ°ç«¯MRR@3 | ç«¯åˆ°ç«¯å»¶è¿Ÿ | ç»„åˆæ˜¾å­˜ | éƒ¨ç½²å¯è¡Œæ€§ |
|---|------|-----------|----------|---------|----------|

## å››ã€é€‰å‹å†³ç­–

**æ¨èåµŒå…¥æ¨¡å‹**: ...
**æ¨è Reranker**: ...
**æ¨èç»„åˆ**: ...
**é…ç½®å‚æ•°**: ...

## äº”ã€8 Collection æ£€ç´¢ç­–ç•¥å»ºè®®

| Collection | æ¨èæ£€ç´¢æ–¹å¼ | ä¾æ® |
|-----------|------------|------|
```

---

## æ–‡ä»¶å˜æ›´æ€»ç»“

| # | æ–‡ä»¶è·¯å¾„ | æ“ä½œ | è¡Œæ•°ä¼°è®¡ | çŠ¶æ€ |
|---|---------|------|---------|------|
| 1 | `requirements.txt` | [MODIFY] | ~6 è¡Œæ–°å¢ | âœ… å·²å®Œæˆ |
| 2 | `scripts/build_eval_dataset.py` | [NEW] | 404 | âœ… å·²å®Œæˆ |
| 3 | `scripts/eval_embedding_models.py` | [NEW] | ~630 | âœ… å·²å®Œæˆ |
| 4 | `scripts/eval_reranker_models.py` | [NEW] | ~650 | âœ… å·²å®Œæˆ |
| 5 | `scripts/eval_combined_pipeline.py` | [NEW] | ~515 | âœ… å·²å®Œæˆ |
| 6 | `scripts/verify_qmd_integration.py` | [NEW] | ~280 | âœ… å·²å®Œæˆ |
| 7 | `eval/embedding/eval_dataset.jsonl` | [NEW] | 100 æ¡ | âœ… å·²å®Œæˆ |
| 8 | `eval/embedding/results/eval_report.md` | [NEW] | ~200 | âœ… å·²å®Œæˆ |
| 9 | `docs/architecture/05-knowledge-base.md` | [MODIFY] | ~20 è¡Œå˜æ›´ | âœ… å·²å®Œæˆ |
| 10 | `docs/PROJECT_OVERVIEW.md` | [MODIFY] | ~5 è¡Œå˜æ›´ | âœ… å·²å®Œæˆ |

**å…¨éƒ¨å®Œæˆ**: 10/10 æ–‡ä»¶

---

## éªŒè¯è®¡åˆ’

```bash
# 1. å®‰è£…ä¾èµ–
conda run -n sca pip install torch --index-url https://download.pytorch.org/whl/cu121
conda run -n sca pip install "sentence-transformers>=2.7.0" "transformers>=4.51.0" numpy scipy
conda run -n sca pip install flash-attn --no-build-isolation

# 2. è¿è¡ŒåµŒå…¥æ¨¡å‹è¯„æµ‹ï¼ˆ5 æ¨¡å‹ï¼ŒGPU ä¸Šçº¦ 20-30 åˆ†é’Ÿï¼‰
conda run -n sca python scripts/eval_embedding_models.py \
    --eval-dataset eval/embedding/eval_dataset.jsonl \
    --fragments docs/knowledge_base/fragments/fragments.jsonl \
    --output eval/embedding/results/

# 3. è¿è¡Œ Reranker è¯„æµ‹ï¼ˆ4 æ¨¡å‹ï¼Œçº¦ 15-20 åˆ†é’Ÿï¼‰
conda run -n sca python scripts/eval_reranker_models.py \
    --eval-dataset eval/embedding/eval_dataset.jsonl \
    --embedding-results eval/embedding/results/ \
    --output eval/embedding/results/

# 4. è”åˆç®¡é“è¯„æµ‹ï¼ˆtop-2 Ã— top-2 = 4 ç»„åˆï¼‰
conda run -n sca python scripts/eval_combined_pipeline.py \
    --eval-dataset eval/embedding/eval_dataset.jsonl \
    --fragments docs/knowledge_base/fragments/fragments.jsonl \
    --output eval/embedding/results/

# 5. æŸ¥çœ‹è¯„æµ‹æŠ¥å‘Š
cat eval/embedding/results/eval_report.md

# 6. qmd é›†æˆéªŒè¯
conda run -n sca python scripts/verify_qmd_integration.py \
    --embedding-model "é€‰å®šåµŒå…¥æ¨¡å‹" \
    --reranker-model "é€‰å®šReranker" \
    --fragments docs/knowledge_base/fragments/fragments.jsonl

# 7. ä»£ç è´¨é‡
conda run -n sca ruff check scripts/
conda run -n sca ruff format --check scripts/
```

**é¢„æœŸè¾“å‡º**ï¼š

| æ£€æŸ¥é¡¹ | é¢„æœŸ |
|--------|------|
| 5 åµŒå…¥æ¨¡å‹è¯„æµ‹ | å…¨éƒ¨å®Œæˆï¼ŒMRR / Hit / é€Ÿåº¦ / æ˜¾å­˜æ•°æ®å®Œæ•´ |
| 4 Reranker è¯„æµ‹ | å…¨éƒ¨å®Œæˆï¼ŒRerank MRR / å¢ç›Š / é€Ÿåº¦ / æ˜¾å­˜æ•°æ®å®Œæ•´ |
| æœ€ä¼˜åµŒå…¥æ¨¡å‹ MRR@3 | â‰¥ 0.80 |
| æœ€ä¼˜ç»„åˆç«¯åˆ°ç«¯ MRR@3 | â‰¥ 0.85 |
| é•¿æ–‡æœ¬è¡°å‡ | æœ‰æ˜ç¡®æ•°æ®ï¼ˆç‰¹åˆ«æ˜¯ >1024 å­—ç‰‡æ®µçš„è¡°å‡å¹…åº¦ï¼‰|
| æŒ‰ç« èŠ‚åˆ†æ | Ch6/Ch7/Ch8 ç»†ç²’åº¦ MRR@3 å¯æ¯”è¾ƒ |
| ç»„åˆæ˜¾å­˜ | â‰¤ 24GBï¼ˆRTX 4090 å¯éƒ¨ç½²ï¼‰ |
| qmd é›†æˆ | embed â†’ store â†’ search â†’ rerank ç«¯åˆ°ç«¯æˆåŠŸ |
| ruff | 0 errors, 0 warnings |

---

## æ‰§è¡Œé¡ºåº

```
é˜¶æ®µ Aï¼ˆç¯å¢ƒï¼‰â”€â†’ é˜¶æ®µ Cï¼ˆåµŒå…¥è¯„æµ‹ï¼‰â”€â†’ é˜¶æ®µ Dï¼ˆReranker è¯„æµ‹ï¼‰â”€â†’ é˜¶æ®µ Eï¼ˆè”åˆ+æŠ¥å‘Šï¼‰â”€â†’ é˜¶æ®µ Fï¼ˆé›†æˆéªŒè¯ï¼‰
     â†“                    â†“                       â†“                        â†“                      â†“
 torch + ST +       5 æ¨¡å‹åµŒå…¥è·‘åˆ†          4 æ¨¡å‹ Rerank è·‘åˆ†        æœ€ä¼˜ç»„åˆç¡®å®š            qmd ç«¯åˆ°ç«¯
 flash-attn +      (é€ä¸ªåŠ è½½é‡Šæ”¾)         (åŸºäºåµŒå…¥ top-10)          å†™è¯„æµ‹æŠ¥å‘Š              è”è°ƒé€šè¿‡
 æ¨¡å‹ä¸‹è½½           ç¼“å­˜å‘é‡ä¾› D å¤ç”¨       æµ‹é€Ÿ+æ˜¾å­˜                æ›´æ–°è®¾è®¡æ–‡æ¡£            æ›´æ–° overview
```

- é˜¶æ®µ B å·²å®Œæˆï¼Œè·³è¿‡
- é˜¶æ®µ A ä¸­æ¨¡å‹ä¸‹è½½å’Œä¾èµ–å®‰è£…å¯å¹¶è¡Œ
- é˜¶æ®µ C å¿…é¡»åœ¨ A å®Œæˆåæ‰§è¡Œï¼ˆéœ€è¦æ¨¡å‹æ–‡ä»¶ï¼‰
- é˜¶æ®µ D ä¾èµ–é˜¶æ®µ C çš„ top-10 å¬å›ç»“æœ
- é˜¶æ®µ E ä¾èµ–é˜¶æ®µ C+D çš„æ‰€æœ‰ç»“æœ
- é˜¶æ®µ F ä¾èµ–é˜¶æ®µ E çš„é€‰å‹å†³ç­–

---

## é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£ |
|------|------|------|------|
| Qwen3-Embedding-8B æ˜¾å­˜è¶…å‡º 24GB | æ— æ³•è¯„æµ‹ 8B æ¨¡å‹ | ä½ | æ¨ç†æ—  KV cacheï¼Œ~16GB åº”å¯è¡Œï¼›è‹¥è¶…å‡ºåˆ™ç”¨ 4-bit é‡åŒ–æˆ–è·³è¿‡ |
| Qwen3-Reranker-8B æ˜¾å­˜è¶…å‡º | æ— æ³•è¯„æµ‹ 8B Reranker | ä¸­ | ä¼˜å…ˆè¯„æµ‹ 4B å’Œ 0.6Bï¼›8B ä½œä¸ºå¯é€‰é¡¹ |
| ç”Ÿäº§éƒ¨ç½²ä¸¤æ¨¡å‹æ˜¾å­˜ä¹‹å’Œè¶…å‡º 24GB | æœ€ä¼˜ç»„åˆæ— æ³•éƒ¨ç½² | ä¸­ | è¯„æµ‹æŠ¥å‘Šä¸­ç»™å‡ºå¤šä¸ªå¯è¡Œç»„åˆï¼ˆå«å¤‡é€‰æ–¹æ¡ˆï¼‰ |
| é•¿ç‰‡æ®µï¼ˆ>2048 å­—ï¼‰åµŒå…¥è´¨é‡æ˜¾è‘—ä¸‹é™ | éƒ¨åˆ†ç‰‡æ®µæ£€ç´¢å¤±æ•ˆ | ä¸­ | è®°å½•è¡°å‡æ•°æ®ï¼›åç»­ K23 å¯è€ƒè™‘å¯¹è¶…é•¿ç‰‡æ®µåˆ†æ®µåµŒå…¥ |
| flash-attn å®‰è£…å¤±è´¥ï¼ˆéœ€ CUDA ç¼–è¯‘ï¼‰ | Qwen3 æ¨ç†é€Ÿåº¦ä¸‹é™ | ä¸­ | é€€å›æ ‡å‡† attentionï¼›é€Ÿåº¦æ…¢ä½†åŠŸèƒ½ä¸å—å½±å“ |
| æ¨¡å‹ä¸‹è½½é€Ÿåº¦æ…¢ï¼ˆæ€»è®¡ ~40GBï¼‰ | è¿›åº¦å»¶è¿Ÿ | ä¸­ | ä½¿ç”¨ hf-mirror.com é•œåƒï¼›ä¼˜å…ˆä¸‹è½½å¿…è¯„æ¨¡å‹ï¼ˆE2/E3/R1/R4ï¼‰|
| qmd ä¸ sentence-transformers â‰¥2.7.0 ä¸å…¼å®¹ | ä¾èµ–å†²çª | ä½ | å·²å¤‡ä»½ `backup_requirements.txt`ï¼›qmd 0.1.0 æ— ç‰ˆæœ¬ä¸Šé™çº¦æŸ |

---

## æŠ€æœ¯å†³ç­–è®°å½•

### ä¸ºä»€ä¹ˆå€™é€‰ä»¥ Qwen3 ç³»åˆ—ä¸ºä¸»ï¼Ÿ

1. **C-MTEB å…¨é¢é¢†å…ˆ**ï¼šQwen3-Embedding-8B åœ¨ C-MTEB Mean ä¸Šè¾¾åˆ° 73.84ï¼ŒQwen3-0.6B (66.33) å·²æ˜¾è‘—è¶…è¿‡ BGE-M3 (59.56)
2. **32K ä¸Šä¸‹æ–‡çª—å£**ï¼šè¦†ç›–å…¨éƒ¨ 692 æ¡ç‰‡æ®µï¼ˆæœ€é•¿ 17155 å­— â‰ˆ 11000 tokenï¼‰ï¼ŒBGE-M3 çš„ 8K ä¹ŸåŸºæœ¬å¤Ÿç”¨ï¼Œä½† bge-large-zh çš„ 512 token ä¼šæˆªæ–­ 24% çš„ç‰‡æ®µ
3. **æŒ‡ä»¤æ„ŸçŸ¥**ï¼šQwen3 æ”¯æŒè‡ªå®šä¹‰ instructionï¼ˆå¦‚"ä¸ºæ–½å·¥æ–¹æ¡ˆç‰‡æ®µç”Ÿæˆæ£€ç´¢å‘é‡"ï¼‰ï¼Œå¯æå‡ 1-5%
4. **é…å¥— Reranker**ï¼šåŒç³»åˆ— Embedding + Reranker ç»„åˆç»è¿‡è”åˆè®­ç»ƒä¼˜åŒ–ï¼Œç†è®ºä¸Šä¼˜äºè·¨ç³»åˆ—æ··æ­
5. **Apache 2.0 å¼€æºåè®®**ï¼šæ— å•†ä¸šä½¿ç”¨é™åˆ¶

### ä¸ºä»€ä¹ˆä¿ç•™ BGE-M3 å’Œ bge-large-zh ä½œä¸ºå¯¹ç…§ï¼Ÿ

1. **BGE-M3**ï¼šDense+Sparse+ColBERT ä¸‰æ¨¡æ€æ£€ç´¢åœ¨æ£€ç´¢å­ä»»åŠ¡ä¸Šæœ‰ç‹¬ç‰¹ä¼˜åŠ¿ï¼Œqmd ä¹Ÿæ”¯æŒæ··åˆæ£€ç´¢ï¼ˆBM25 + å‘é‡ + RRFï¼‰
2. **bge-large-zh-v1.5**ï¼š512 token é™åˆ¶ä¸‹çš„**è¡°å‡åŸºçº¿** â€” å¯é‡åŒ–é•¿æ–‡æœ¬å¯¹ embedding è´¨é‡çš„å®é™…å½±å“ã€‚692 æ¡ç‰‡æ®µä¸­ 24% è¶…è¿‡ 512 å­—ï¼Œéœ€è¦æ•°æ®æ”¯æ’‘"é•¿æ–‡æœ¬å¾ˆé‡è¦"è¿™ä¸ªå‡è®¾
3. **æˆç†Ÿåº¦**ï¼šBGE ç³»åˆ—ç»è¿‡å¤§è§„æ¨¡ç”Ÿäº§éªŒè¯ï¼Œç¨³å®šæ€§æœ‰ä¿éšœ

### ä¸ºä»€ä¹ˆæ’é™¤äº† text2vec / m3e / stellaï¼Ÿ

åŸå§‹ä»»åŠ¡æè¿°æåˆ° "bge-m3 vs text2vec ç­‰"ï¼Œä½†ç»è¿‡ C-MTEB æœ€æ–°æ’ååˆ†æï¼š

1. **text2vec-large-chinese**ï¼šC-MTEB æ’åå·²è¢« Qwen3 å’Œ BGE å¤§å¹…è¶…è¶Šï¼ˆC-MTEB Mean ~47 vs Qwen3-0.6B 66.33ï¼‰ï¼Œä¸åœ¨åŒä¸€æ¢¯é˜Ÿ
2. **m3e-large**ï¼šç¤¾åŒºæ¨¡å‹ï¼Œè®­ç»ƒæ•°æ®åå‘ç”µå•†/é€šç”¨ï¼Œå·¥ç¨‹é¢†åŸŸæ³›åŒ–èƒ½åŠ›å¼±ï¼ŒC-MTEB ~52
3. **stella**ï¼šä¸»è¦é¢å‘è‹±æ–‡ï¼Œä¸­æ–‡èƒ½åŠ›æ•°æ®ä¸è¶³

> **ç»“è®º**ï¼šç”¨ bge-large-zh-v1.5 ä½œä¸º"ä¸­ç­‰æ°´å¹³åŸºçº¿"å·²è¶³å¤Ÿï¼Œæ— éœ€å†åŠ å…¥æ›´å¼±çš„ text2vecã€‚å°†è¯„æµ‹èµ„æºé›†ä¸­åœ¨æ›´æœ‰ç«äº‰åŠ›çš„å€™é€‰ä¸Šã€‚

### Reranker ä¸ºä»€ä¹ˆä¸è¯„æµ‹ Jinaï¼Ÿ

1. **è®¸å¯è¯**ï¼šJina Reranker v2/v3 é‡‡ç”¨ CC-BY-NC-4.0ï¼Œç ”ç©¶å¯ç”¨ä½†åç»­å•†ä¸šåŒ–å­˜åœ¨éšæ‚£
2. **ä¸­æ–‡ä¸“é¡¹**ï¼šQwen3-Reranker åœ¨ CMTEB-R ä¸Šé¢†å…ˆ Jinaï¼Œä¸­æ–‡åœºæ™¯æ›´ä¼˜
3. **é…å¥—æ€§**ï¼šQwen3 Embedding + Qwen3 Reranker ç»è¿‡è”åˆè®­ç»ƒï¼ŒååŒæ•ˆæœæ›´å¥½

### è¯„æµ‹æ•°æ®é›†ä¸ºä»€ä¹ˆåªæ„é€  100 ç»„ï¼Ÿ

1. K16 å·²å»é‡ï¼Œ692 æ¡ç‰‡æ®µé—´é‡å¤åº¦ä½
2. æŒ‰ç« èŠ‚ Ã— å·¥ç¨‹ç±»å‹åˆ†å±‚ 100 ç»„è¦†ç›–å…¨éƒ¨ 10 ç«  + 8 ç§å·¥ç¨‹ç±»å‹
3. å«é•¿æ–‡æœ¬ä¿éšœï¼ˆâ‰¥15 æ¡ >512 å­—ï¼Œâ‰¥5 æ¡ >1024 å­—ï¼‰
4. MVP åŸåˆ™ï¼š100 ç»„ Ã— 9 æ¨¡å‹ = 900 æ¬¡è¯„æµ‹ï¼Œç»“è®ºå¯é ä¸”æˆæœ¬å¯æ§

---

## ä¸åç»­ä»»åŠ¡çš„å…³ç³»

| ä¸‹æ¸¸ä»»åŠ¡ | ä¾èµ–æ–¹å¼ |
|---------|---------|
| **K23** å‘é‡åº“æ„å»º | ä½¿ç”¨ K20 é€‰å®šçš„ Embedding æ¨¡å‹ + å‚æ•°ï¼ŒåµŒå…¥ 692 æ¡ç‰‡æ®µå…¥ 8 ä¸ª Collection |
| **S9** VectorStore | `SentenceTransformerBackend(model_name=é€‰å®šæ¨¡å‹, model_kwargs=...)` |
| **S10** KnowledgeRetriever | Embedding å¬å› + Reranker é‡æ’çš„ä¸¤é˜¶æ®µæ£€ç´¢ç®¡é“ |
| **K21** å®ä½“/å…³ç³»æŠ½å– | æ— ç›´æ¥ä¾èµ–ï¼ˆLLM ä»»åŠ¡ï¼‰ |
| **K22** çŸ¥è¯†å›¾è°±æ„å»º | æ— ç›´æ¥ä¾èµ–ï¼ˆLightRAG æœ‰è‡ªå·±çš„åµŒå…¥æ–¹æ¡ˆï¼‰ |

---

## å‚è€ƒèµ„æ–™

- [Qwen3-Embedding å®˜æ–¹åšå®¢](https://qwenlm.github.io/blog/qwen3-embedding/) â€” æ¨¡å‹æ¶æ„ã€CMTEB è¯„æµ‹
- [Qwen3-Embedding-0.6B HuggingFace](https://huggingface.co/Qwen/Qwen3-Embedding-0.6B) â€” C-MTEB è¯¦ç»†åˆ†æ•°
- [BAAI/bge-m3 HuggingFace](https://huggingface.co/BAAI/bge-m3) â€” å¤šç²’åº¦æ£€ç´¢
- [C-MTEB åŸºå‡†](https://github.com/embeddings-benchmark/mteb) â€” ä¸­æ–‡æ–‡æœ¬åµŒå…¥è¯„æµ‹æ ‡å‡†
- [Qwen3 vs BGE-M3 å¯¹æ¯”åˆ†æ](https://medium.com/@mrAryanKumar/comparative-analysis-of-qwen-3-and-bge-m3-embedding-models-for-multilingual-information-retrieval-72c0e6895413)
- [å¼€æºåµŒå…¥æ¨¡å‹æŒ‡å— 2026](https://www.bentoml.com/blog/a-guide-to-open-source-embedding-models)
- [Reranker æ’è¡Œæ¦œ](https://agentset.ai/rerankers)
- [Reranker é€‰å‹æŒ‡å— 2026](https://www.zeroentropy.dev/articles/ultimate-guide-to-choosing-the-best-reranking-model-in-2025)

---

*è®¡åˆ’æ›´æ–°ï¼š2026-02-25 | åŸºäº C-MTEB æœ€æ–°æ’å + K16 æå–æŠ¥å‘Š + 05-knowledge-base è®¾è®¡ + qmd æºç åˆ†æ + RTX 4090 ç¡¬ä»¶éªŒè¯ + å…¨é‡æ–‡æ¡£æ¢ç´¢*
