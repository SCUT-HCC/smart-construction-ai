# 知识库设计

> 双引擎架构：qmd + sqlite-vec（案例检索）+ LightRAG（规则推理）。

## 为什么两个引擎

| 需求 | qmd | LightRAG |
|------|-----|----------|
| "找一段高质量的混凝土浇筑工艺描述" | ✅ 向量相似度检索 | ❌ |
| "基坑工程应该识别哪些危险源" | ❌ | ✅ 实体关系推理 |
| "和 DOC 6 类似的质量管理写法" | ✅ 语义匹配 | ❌ |
| "用了XX施工方法 → 必须有XX质量控制" | ❌ | ✅ 逻辑推导 |

**融合策略**：`强制规范(LightRAG) > 参考案例(qmd) > 自由生成`

## qmd + sqlite-vec — 案例检索

### Collection 设计

按章节分 collection，避免跨章节噪声：

| Collection | 内容 | 检索场景 |
|-----------|------|---------|
| `ch01_basis` | 编制依据中的标准列表 | 生成第一章时检索相关标准 |
| `ch06_methods` | 施工方法与工艺流程 | 按工程类型检索工艺写法 |
| `ch07_quality` | 质量管理措施 | 按工序检索质量要点 |
| `ch08_safety` | 安全措施与危险源 | 按工序检索安全要求 |
| `ch09_emergency` | 应急处置措施 | 按事故类型检索处置方法 |
| `ch10_green` | 绿色施工 | 检索四节一环保措施 |
| `equipment` | 设备参数表、计算书 | 按设备类型检索 |
| `templates` | 通用模板段落（组织机构、职责等） | 直接填充 |

> **ch02-ch05 未设独立 collection 的理由**：
> - 第二章（工程概况）：内容主要来自用户输入（工程参数），无需检索
> - 第三章（组织机构）：组织架构和职责高度模板化，由 `templates` collection 覆盖
> - 第四章（施工安排）：施工顺序依赖工程类型，从 `ch06_methods` 中推导工序流程
> - 第五章（施工准备）：设备清单由 `equipment` collection 覆盖，其余为通用模板

### 嵌入策略

- **嵌入模型**：Qwen3-Embedding-0.6B（K20 评测选定，MRR@3=0.8600，显存 1146MB，维度 1024）
- **Reranker**：Qwen3-Reranker-0.6B（Rerank MRR@3=0.8683，CausalLM 架构，组合显存 2.3GB）
- **E2E 效果**：MRR@3=0.8683，Hit@1=82%，Hit@3=92%，端到端延迟 169ms
- **备选高精度组合**：Qwen3-Reranker-4B（E2E MRR@3=0.8933，组合显存 8.9GB，延迟 355ms）
- **chunk_size**：按知识提取策略中定义的粒度（子章节级），不做固定长度切分
- **overlap**：0（子章节已是独立语义单元）

### 检索参数

```
top_k = 3            # 每次检索返回前 3 个最相关片段
threshold = 0.6      # 相似度阈值，低于此值不返回
filter = {
    "chapter": "...",           # 按目标章节过滤
    "engineering_type": "..."   # 按工程类型过滤
}
```

## LightRAG — 规则推理

### 知识图谱构建

从 16 篇文档中提取**实体和关系**：

| 实体类型 | 示例 |
|---------|------|
| 工程类型 | 灌注桩基础、变压器安装、钢结构 |
| 施工工序 | 钻孔、清孔、浇筑、吊装 |
| 设备 | QY160 起重机、旋转钻机、振动锤 |
| 危险源 | 坍塌、高处坠落、触电、物体打击 |
| 质量要点 | 保护层厚度、振捣密实度、垂直度偏差 |
| 规范标准 | GB 50300、DL/T 5210 |

| 关系类型 | 示例 |
|---------|------|
| 工序→需要→设备 | 灌注桩 → 需要 → 旋转钻机 |
| 工序→产生→危险源 | 基坑开挖 → 产生 → 坍塌风险 |
| 危险源→对应→安全措施 | 高处坠落 → 对应 → 安全带+防护栏 |
| 危险源→对应→应急处置 | 触电 → 对应 → 断电+CPR |
| 工序→要求→质量要点 | 混凝土浇筑 → 要求 → 振捣密实 |
| 工程类型→包含→工序 | 基础工程 → 包含 → 开挖/扎筋/浇筑/养护 |

### 推理场景

```
输入："本工程为灌注桩基础，采用旋转钻机成孔"
推理：灌注桩 → 包含工序 [钻孔, 清孔, 钢筋笼下放, 混凝土灌注]
     → 每个工序的危险源
     → 每个危险源的安全措施
     → 每个工序的质量要点
输出：结构化的安全/质量要求清单
```

## 融合策略

生成每一章时，两个引擎的结果按优先级合并：

```
1. LightRAG 推理出的强制规范/规则       → 必须包含
2. qmd 检索出的 top 3 相似案例片段       → 参考措辞和结构
3. 通用模板（templates collection）       → 补充框架
4. LLM 自由生成                          → 填充剩余部分
```

## 核心类

| 类 | 职责 |
|---|------|
| `KnowledgeRetriever` | 统一检索接口，协调 qmd + LightRAG |
| `retrieve_regulations()` | 从 LightRAG 检索强制规范 |
| `retrieve_cases(chapter, engineering_type)` | 从 qmd 检索案例片段 |
| `infer_rules(context)` | LightRAG 推理（工序→危险源→措施） |
